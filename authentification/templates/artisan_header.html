{% load static %} 
<head>   
  <link rel="stylesheet" href="{% static 'authentification/css/header.css' %}"> 
  <style>
    /* Only adding styles for notification dropdown effects */
    #notification {
      position: relative;
      cursor: pointer;
    }
    
    #notification-drop-down {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      width: 300px;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .notification-item a {
      text-decoration: none;
      color: #333;
    }
    
    .mark_as_done {
      cursor: pointer;
      color: blue;
      font-size: 12px;
    }
    
    #noti_span {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: red;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>   
<header>    
  <div class="header-div"> <span class="logo">Bricole</span> 
    <nav>    
      <a href="" class="hover">Home</a>    
      <div id="language">   
        <img src="{% static 'authentification/image/globe.png' %}" alt="globe">     
        <a href=""> English</a>     
      </div>   
      <a href="">Contact us</a>
      <a href="" class="gradient-text">Become an Artisan</a>  
      <a href="{% url 'sign_client' %}">Sign in</a>   
      <a href="{% url 'signup' %}" id="join">Join</a> 
      <div id='notification'>
        <img src="{% static 'authentification/image/notification.png' %}" alt="notification" class="bell-icon">  
        {% if notis %}
        <span id='noti_span'>{{ notis_nbr }}</span>
        {% endif %}
      </div>
    </nav> 
  </div> 
</header>
<div id='notification-drop-down'>
  {% for notification in notis %}
  <div class="notification-item">
    <a href='http://127.0.0.1:8000/dashboard'>
      <strong>{{notification.demande.titre}}</strong><br>
      {{notification.demande.description}}<br>
      <small class="text-muted">2 mins ago</small>
    </a>
    <span class='mark_as_done' data-id='{{ notification.id }}'>mark as seen</span>
  </div>
  {% endfor %}
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle notification dropdown on click
    const notificationIcon = document.getElementById('notification');
    const notificationDropdown = document.getElementById('notification-drop-down');
    
    notificationIcon.addEventListener('click', function() {
      if (notificationDropdown.style.display === 'block') {
        notificationDropdown.style.display = 'none';
      } else {
        notificationDropdown.style.display = 'block';
      }
    });
    
    // Close when clicking outside
    document.addEventListener('click', function(event) {
      if (!notificationIcon.contains(event.target) && !notificationDropdown.contains(event.target)) {
        notificationDropdown.style.display = 'none';
      }
    });
  });

  const notificationSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/notifications/'
  );

  notificationSocket.onmessage = function(e) {
    playNotificationSound()
    if ("Notification" in window) {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification("ðŸ”” Test Notification", {
            body: "It works! ðŸŽ‰",
            icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png" // optional
          });
        } else {
          console.log("Notification permission denied.");
        }
      });
    } else {
      console.log("Browser does not support notifications.");
    }
    
    const data = JSON.parse(e.data);
    console.log(e)
    
    let noti=document.getElementById('notification')
    let noti_span=document.getElementById("noti_span")
    if (noti_span ==null){
      let span= document.createElement("span")
      span.id='noti_span'
      span.textContent='1'
      noti.appendChild(span)
    }else{
      let nbr_noti =parseInt(noti_span.textContent)
      nbr_noti+=1
      noti_span.textContent=nbr_noti
    }
    document.getElementById("notification-drop-down").innerHTML+=`
    <div class="notification-item">
    <a href='http://127.0.0.1:8000/dashboard'>
      <strong>${data.data.title}</strong><br>
      ${data.notification}<br>
      <small class="text-muted">2 mins ago</small>
      </a>
      <span class='mark_as_done' data-id='${data.data.noti_id}'>mark as seen</span>
    </div>
      `

      markDone()
  };

  function playNotificationSound() {
    const audio = new Audio("{% static 'authentification/audio/notification.mp3' %}");
    audio.play();
  }
  
  async function markDone(){
    let mark_done=document.querySelectorAll('span.mark_as_done')
    mark_done.forEach(element=>{
      console.log("cicked")
      element.addEventListener("click",async function(e){
        id=e.target.dataset.id
        console.log("my id is "+id)
        const response = await fetch('{% url "mark_as_done" %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id }),
        });
        const data = await response.json();
        console.log(data);
        let parent=e.target.parentElement
        parent.remove()
        let noti_nbr=document.getElementById("noti_span").textContent
        noti_nbr= parseInt(noti_nbr)-1
        if (noti_nbr>0){
        document.getElementById("noti_span").textContent=noti_nbr
        }else{
          document.getElementById("noti_span").remove()
        }
      })
    })
  } 
  
  markDone();
</script> 