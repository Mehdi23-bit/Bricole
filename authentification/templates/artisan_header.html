{% load static %} 
<head>   
  <link rel="stylesheet" href="{% static 'authentification/css/header.css' %}"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    /* Only adding styles for notification dropdown effects */
    #notification {
      position: relative;
      cursor: pointer;
    }
    
    #notification-drop-down {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      width: 300px;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .notification-item a {
      text-decoration: none;
      color: #333;
    }
    
    .mark_as_done {
      cursor: pointer;
      color: blue;
      font-size: 12px;
    }
    
    #noti_span {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: red;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6); /* semi-transparent dark */
      display: none; /* hidden by default */
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .checked {
      color: orange;
    }
  </style>
</head>   
<header>    
  <div class="header-div"> <span class="logo">Bricole</span> 
    <nav>    
      <a href="" class="hover">Home</a>    
      <div id="language">   
        <img src="{% static 'authentification/image/globe.png' %}" alt="globe">     
        <a href=""> English</a>     
      </div>   
      <a href="">Contact us</a>
      <a href="" class="gradient-text">Become an Artisan</a>  
      <a href="{% url 'sign_client' %}">Sign in</a>   
      <a href="{% url 'signup' %}" id="join">Join</a> 
      <div id='notification'>
        <img src="{% static 'authentification/image/notification.png' %}" alt="notification" class="bell-icon">  
        {% if notis %}
        <span id='noti_span'>{{ notis_nbr }}</span>
        {% endif %}
      </div>
    </nav> 
  </div> 
</header>
<div id='notification-drop-down'>
  {% for notification in notis %}
  <div class="notification-item">
    <a href='http://127.0.0.1:8000/dashboard'>
      <strong>{{notification.demande.titre}}</strong><br>
      {{notification.demande.description}}<br>
      <small class="text-muted">2 mins ago</small>
    </a>
    <span class='mark_as_done' data-id='{{ notification.id }}'>mark as seen</span>
  </div>
  {% endfor %}
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Toggle notification dropdown on click
    const notificationIcon = document.getElementById('notification');
    const notificationDropdown = document.getElementById('notification-drop-down');
    
    notificationIcon.addEventListener('click', function() {
      if (notificationDropdown.style.display === 'block') {
        notificationDropdown.style.display = 'none';
      } else {
        notificationDropdown.style.display = 'block';
      }
    });
    
    // Close when clicking outside
    document.addEventListener('click', function(event) {
      if (!notificationIcon.contains(event.target) && !notificationDropdown.contains(event.target)) {
        notificationDropdown.style.display = 'none';
      }
    });

   
      // Add these styles to your existing style section
      const styleElement = document.createElement('style');
      styleElement.textContent = `
        .overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 998;
        }
        
        #harassment-popup {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: white;
          border: 2px solid #d9534f;
          padding: 25px;
          z-index: 1001;
          box-shadow: 0 4px 15px rgba(0,0,0,0.3);
          border-radius: 8px;
          text-align: center;
          font-family: sans-serif;
          max-width: 400px;
          width: 90%;
        }
        
        #harassment-popup h2 {
          color: #d9534f;
          margin-top: 0;
        }
        
        #harassment-popup p {
          margin: 15px 0;
          line-height: 1.5;
        }
        
        #harassment-popup button {
          background-color: #d9534f;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          font-weight: bold;
          transition: background-color 0.2s;
        }
        
        #harassment-popup button:hover {
          background-color: #c9302c;
        }
      `;
      document.head.appendChild(styleElement);
    });
 

  const notificationSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/notifications/'
  );

  notificationSocket.onmessage = function(e) {
   
    playNotificationSound()
    if ("Notification" in window) {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification("ðŸ”” Test Notification", {
            body: "It works! ðŸŽ‰",
            icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png" // optional
          });
        } else {
          console.log("Notification permission denied.");
        }
      });
    } else {
      console.log("Browser does not support notifications.");
    }
    
    const data = JSON.parse(e.data);
    const type=data.data.type_notification
    const id=data.data.demande_id
    localStorage.setItem("id",id)
    if (type == "harasse" && localStorage.getItem("mode")!="harasse") {
      // Create overlay div
      localStorage.setItem("mode", "harasse");
      const overlayDiv = document.createElement("div");
      overlayDiv.id = "notification-overlay";
      overlayDiv.className = "overlay";
      document.body.appendChild(overlayDiv);
      
      // Create popup content
      const popup = document.createElement("div");
      popup.id = "harassment-popup";
      popup.innerHTML = `
       <form id="comment"> 
<span class="fa fa-star checked"></span>
<span class="fa fa-star checked"></span>
<span class="fa fa-star checked"></span>
<span class="fa fa-star"></span>
<span class="fa fa-star"></span>
       <textarea name='comment'></textarea>
         <input type="submit">
       </form>
      
      `;
      
      // Append popup to body
      document.body.appendChild(popup);
      commentform()
    }
    else if(type!="harasse" ){ 
    let noti=document.getElementById('notification')
    let noti_span=document.getElementById("noti_span")
    if (noti_span ==null){
      let span= document.createElement("span")
      span.id='noti_span'
      span.textContent='1'
      noti.appendChild(span)
    }else{
      let nbr_noti =parseInt(noti_span.textContent)
      nbr_noti+=1
      noti_span.textContent=nbr_noti
    }
    document.getElementById("notification-drop-down").innerHTML+=`
    <div class="notification-item">
    <a href='http://127.0.0.1:8000/dashboard'>
      <strong>${data.data.title}</strong><br>
      ${data.notification}<br>
      <small class="text-muted">2 mins ago</small>
      </a>
      <span class='mark_as_done' data-id='${data.data.noti_id}'>mark as seen</span>
    </div>
      `

      markDone()
  }
  };

  function playNotificationSound() {
    const audio = new Audio("{% static 'authentification/audio/notification.mp3' %}");
    audio.play();
  }
  
  async function markDone(){
    let mark_done=document.querySelectorAll('span.mark_as_done')
    mark_done.forEach(element=>{
      console.log("cicked")
      element.addEventListener("click",async function(e){
        id=e.target.dataset.id
        console.log("my id is "+id)
        const response = await fetch('{% url "mark_as_done" %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id }),
        });
        const data = await response.json();
        console.log(data);
        let parent=e.target.parentElement
        parent.remove()
        let noti_nbr=document.getElementById("noti_span").textContent
        noti_nbr= parseInt(noti_nbr)-1
        if (noti_nbr>0){
        document.getElementById("noti_span").textContent=noti_nbr
        }else{
          document.getElementById("noti_span").remove()
        }
      })
    })
  } 
  
  markDone();
  // Add this function to close the harassment popup
function closeHarassmentPopup() {
  const popup = document.getElementById("harassment-popup");
  const overlay = document.getElementById("notification-overlay");
  
  if (popup) {
    popup.style.opacity = "0";
    popup.style.transition = "opacity 0.3s ease";
    setTimeout(() => popup.remove(), 300);
  }
  
  if (overlay) {
    overlay.style.opacity = "0";
    overlay.style.transition = "opacity 0.3s ease";
    setTimeout(() => overlay.remove(), 300);
  }
}

// Make sure this function is accessible globally
window.closeHarassmentPopup = closeHarassmentPopup;
function commentform(){
  document.getElementById("comment").addEventListener("submit",async function(e){
e.preventDefault();
const form=new FormData(e.target)
console.log(form.get("comment"))
const result=await fetch("{% url 'comment' %}",{

  method:'POST',
  headers:{
      'X-CSRFToken': '{{ csrf_token }}'
  },
  body:JSON.stringify({ comment: form.get("comment"),id:localStorage.getItem("id"),rate:document.getElementById("comment").querySelectorAll(".fa.fa-star.checked").length }),

})
const data = await result.json()

if(data.result=="success"){-
  console.log(data.result)
  localStorage.clear()
  document.getElementById("harassment-popup").remove()
}else if(data.result=="failled"){
  console.log(data.result)
  console.log("sorry please try again")
}
  })

  stars=Array.from(document.getElementById("comment").querySelectorAll(".fa.fa-star"))
  stars.forEach(star=>{
    star.addEventListener("click",(e)=>{
      
      for(let i=0;i<stars.indexOf(star)+1;i++){
        stars[i].classList.add("checked")
      }  
      for(let i=stars.indexOf(star)+1;i<stars.length;i++){
        stars[i].classList.remove("checked")
      }
    })
  })
  

}
</script> 